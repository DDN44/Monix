#include <stdker.h>
#include <irq.h>
#include <mem.h>

uint8_t lastkey;
uint8_t keyrel;

static uint8_t scantable1[256] =
{
//  1     2     3     4     5     6     7     8     9     0    a     b    c     d     e     f
    0x00, 0x00, 0x31, 0x32, 0x33, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //0
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, '\n', 0x00, 0x00, 0x00, //1
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //2
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //3
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //4
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //5
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //6
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //7
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //8
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //9
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //a
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //b
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //c
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //d
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //e
    0x00, 0x00, '1', '2', '3', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //f
};

void keyboard_out(uint8_t value)
{
    while((inb(0x64) & 0b10))
    {
        con_print("waiting for ps2");
        con_newln();
    }
    outb(0x60, value);
}

uint8_t keyboard_in()
{
    while((inb(0x64) & 0b01))
    {
        con_print("waiting for ps2");
        con_newln();
    }
    return inb(0x60);
}

void keyboard_test()
{
    outb(0x64, 0xAA);
    uint8_t contresult = inb(0x60);
    if(contresult = 0x55)
    {
        con_print("ps2 test passed:");
        con_print_hex32(contresult);
        con_newln;
    }else
    {
        con_print("ps2 test failed:");
        con_print_hex32(contresult);
        con_newln;
    }
}

void init_keyboard()
{
    //keyboard_test();
    cli();

    outb(0x64, 0xAD);
    outb(0x64, 0xA7);
    outb(0x64, 0xAA);

    if(inb(0x60) == 0x55)
    {
    }else
    {
        con_print("ps2 failure");
    }
    // test ps2 port
    outb(0x64, 0xAB);

    if(inb(0x60) == 0x00)
    {
    }else
    {
        con_print("ps2 port failure");
    }
    //enable ps2 port
    outb(0x64, 0xAE);
    
    outb(0x64, 0x20);
    uint8_t configbyte = inb(0x60);
    configbyte = configbyte & 0b1;
    outb(0x60, configbyte);
    outb(0x64, 0x60);

trythefuckagain:
    outb(0x60, 0xFF);
    asm("nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    nop;\
    ");
    uint8_t testresult = inb(0x60);
    testresult = inb(0x60);
    if(testresult == 0xFE) goto trythefuckagain;
    if(testresult == 0xAA)
    {
        con_print("ps2 success :3");
        con_newln();
    }
    if((testresult == 0xFC) || (testresult == 0xFD))
    {
        con_print("self test fail :( :: )");
        con_print_hex32(testresult);
        con_newln();
    }
    con_print_hex32(testresult);
    outb(0x60, 0xF4);
    inb(0x60);
    // hopefully the keyboard is working by now
    outb(0x60, 0xF0);
    outb(0x60, 0x02);
    sti();
}

uint8_t poll_keyboard()
{
    keyrel = 0;
    uint8_t tempkey = inb(0x60);
    if((tempkey & 0x80) >> 7 == 1)
    {
        keyrel = 1;
        return 0;
    }
    tempkey = scantable1[tempkey];
    lastkey = tempkey;
    return tempkey;
}